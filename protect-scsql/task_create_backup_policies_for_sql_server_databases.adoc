---
permalink: protect-scsql/task_create_backup_policies_for_sql_server_databases.html 
sidebar: sidebar 
keywords: backup policy 
summary: SnapCenter を使用して SQL Server リソースをバックアップする前に、リソースまたはリソースグループのバックアップポリシーを作成することができます。また、リソースグループの作成時や単一のリソースのバックアップ時にバックアップポリシーを作成することもできます。 
---
= SQL Server データベースのバックアップポリシーを作成する
:allow-uri-read: 
:icons: font
:imagesdir: ../media/


[role="lead"]
SnapCenter を使用して SQL Server リソースをバックアップする前に、リソースまたはリソースグループのバックアップポリシーを作成することができます。また、リソースグループの作成時や単一のリソースのバックアップ時にバックアップポリシーを作成することもできます。

.作業を開始する前に
* データ保護戦略を定義しておく必要があります。
* SnapCenter のインストール、ホストの追加、リソースの特定、ストレージシステム接続の作成などのタスクを実行して、データ保護の準備をしておく必要があります。
* ログバックアップ用のホストログディレクトリを設定しておく必要があります。
* SQL Server リソースを更新（検出）しておく必要があります。
* Snapshot コピーをミラーまたはバックアップにレプリケートするユーザには、 SnapCenter 管理者がユーザに対してソースとデスティネーションの両方のボリューム用に Storage Virtual Machine （ SVM ）を割り当てる必要があります。
+
管理者によるユーザへのリソースの割り当て方法については、 SnapCenter のインストール情報を参照してください。

* プリスクリプトとポストスクリプトで PowerShell スクリプトを実行する場合は、 web.config ファイルで usePowershellProcessforScripts パラメータの値を true に設定する必要があります。
+
デフォルト値は false です。



.このタスクについて
バックアップポリシーとは、バックアップを管理および保持する方法やリソースやリソースグループをバックアップする頻度を定めた一連のルールです。レプリケーションとスクリプトの設定を指定することもできます。ポリシーでオプションを指定しておくことで、別のリソースグループにポリシーを再利用して時間を節約することができます。

scripts_pathは、プラグインホストのSMCoreServiceHost.exe.ConfigファイルにあるPredefinedWindowsScriptsDirectoryキーを使用して定義されます。

必要に応じて、このパスを変更し、SMcoreサービスを再起動できます。セキュリティのためにデフォルトパスを使用することを推奨します。

キーの値は、api/4.7/configsettingsを介してスワッガーから表示できます

GET APIを使用してキーの値を表示することができます。set APIはサポートされません。



== 手順1：ポリシー名を作成します

. 左側のナビゲーションペインで、*[設定]*を選択します。
. [設定]ページで、*[ポリシー]*を選択します。
. [New]*を選択します。
. [* 名前 *] ページで、ポリシー名と概要を入力します。




== ステップ2：バックアップオプションを設定します

. バックアップタイプを選択します


[role="tabbed-block"]
====
.フルバックアップとログバックアップ
--
データベースファイルとトランザクションログをバックアップし、トランザクションログを切り捨てます。

. [ フルバックアップおよびログバックアップ * ] を選択します。
. 各 Snapshot コピーにバックアップするデータベースの最大数を入力します。
+

NOTE: 同時に複数のバックアップ処理を実行する場合は、この値を増やす必要があります。



--
.フル・バックアップ
--
データベースファイルをバックアップします。

. [* Full backup* ] を選択します。
. 各 Snapshot コピーにバックアップするデータベースの最大数を入力します。デフォルト値は 100 です
+

NOTE: 同時に複数のバックアップ処理を実行する場合は、この値を増やす必要があります。



--
.ログバックアップ
--
トランザクションログをバックアップします。。「 * Log backup * 」を選択します。

--
.コピーのみのバックアップ
--
. 別のバックアップ・アプリケーションを使用してリソースをバックアップする場合は、 [* コピーのみのバックアップ * ] を選択します。


トランザクションログが変更されずに保持されるため、任意のバックアップアプリケーションでデータベースをリストアできます。通常、他の状況ではコピーのみのオプションを使用しないでください。


NOTE: Microsoft SQL では、セカンダリ・ストレージのフル・バックアップおよびログ・バックアップ * オプションと * コピーのみのバックアップ * オプションはサポートされていません。

--
====
. 可用性グループの設定セクションで、次の操作を実行します。
+
.. 優先バックアップレプリカのみにバックアップ。
+
優先バックアップレプリカのみをバックアップする場合は、このオプションを選択します。優先バックアップレプリカは、 SQL Server の AG に対して設定されているバックアップ設定によって決まります。

.. バックアップするレプリカを選択します。
+
バックアップするプライマリまたはセカンダリの AG レプリカを選択します。

.. バックアップ優先度の選択（最小および最大バックアップ優先度）
+
バックアップする AG レプリカを決めるための、バックアップの最小優先順位と最大優先順位を指定します。たとえば、最小優先度を 10 、最大優先度を 50 に設定できます。この場合、優先順位が 10 より高く 50 より低いすべての AG レプリカがバックアップ用とみなされます。

+
デフォルトでは、最小プライオリティは 1 、最大プライオリティは 100 です。



+

NOTE: クラスタ構成では、ポリシーで設定された保持設定に従って、クラスタの各ノードにバックアップが保持されます。AG の所有者ノードが変更された場合は、保持設定に従ってバックアップが作成され、以前の所有者ノードのバックアップが保持されます。AG の保持設定はノードレベルでのみ適用されます。

. このポリシーのバックアップ頻度をスケジュールします。スケジュールタイプを指定するには、*オンデマンド*、*毎時*、*毎日*、*毎週*、または*毎月*を選択します。
+
ポリシーに対して選択できるスケジュールタイプは1つだけです。

+
image::../media/backup_settings.gif[バックアップ設定]

+

NOTE: リソースグループを作成する際に、バックアップ処理のスケジュール（開始日、終了日、頻度）を指定することができます。これにより、ポリシーとバックアップ間隔が同じである複数のリソースグループを作成できますが、各ポリシーに異なるバックアップスケジュールを割り当てることもできます。

+

NOTE: 午前 2 時にスケジュールを設定した場合、夏時間（ DST ）中はスケジュールはトリガーされません。





== ステップ3：保持設定を構成する

[ 保持 ] ページでは、 [ バックアップ・タイプ ] ページで選択したバックアップ・タイプに応じて、次のアクションを 1 つ以上実行します。

. [ 最新の状態へのリストア処理の保持の設定 ] セクションで、次のいずれかを実行します。


[role="tabbed-block"]
====
.特定のコピー数
--
特定の数のSnapshotコピーのみを保持します。

. ［ * 最新の < 日数 > 日数に適用可能なログバックアップを保持する ］ オプションを選択し、保持する日数を指定します。この上限に近づいた場合は、古いコピーを削除できます。


--
.特定の日数
--
バックアップコピーを特定の日数だけ保持します。

. ［ * 最新の < 日数 > フル・バックアップに適用可能なログ・バックアップを保持する ］ オプションを選択し、ログ・バックアップ・コピーを保持する日数を指定します。


--
====
. On Demand の保持設定の「 * フルバックアップの保持設定 * 」セクションで、次の操作を実行します。
+
.. 保持するSnapshotコピーの総数を指定します
+
... 保持するSnapshotコピーの数を指定するには、*保持するSnapshotコピーの総数*を選択します。
... Snapshot コピーの数が指定した数を超えると、古いものから順に Snapshot コピーが削除されます。







IMPORTANT: デフォルトでは、保持数の値は 2 に設定されます。保持数を 1 に設定すると、新しい Snapshot コピーがターゲットにレプリケートされるまで最初の Snapshot コピーが SnapVault 関係の参照 Snapshot コピーになるため、保持処理が失敗することがあります。


NOTE: 最大保持数は、 ONTAP 9.4 以降のリソースでは 1018 、 ONTAP 9.3 以前のリソースでは 254 です。保持期間を基盤となる ONTAP バージョンの値よりも大きい値に設定すると、バックアップが失敗します。

. Snapshotコピーを保持する期間
+
.. Snapshot コピーを削除するまで保持しておく日数を指定する場合は、「 * Snapshot コピーを保持する期間」を選択します。




. [ 毎時 ] 、 [ 毎日 ] 、 [ 毎週 ] 、および [ 毎月 ] の保持設定の [ フルバックアップ保持設定 *] セクションで、 [ バックアップタイプ ] ページで選択したスケジュールタイプの保持設定を指定します。
+
.. 保持するSnapshotコピーの総数を指定します
+
... 保持するSnapshotコピーの数を指定するには、*保持するSnapshotコピーの総数*を選択します。Snapshot コピーの数が指定した数を超えると、古いものから順に Snapshot コピーが削除されます。







IMPORTANT: SnapVault レプリケーションを有効にする場合は、保持数を 2 以上に設定する必要があります。保持数を 1 に設定すると、新しい Snapshot コピーがターゲットにレプリケートされるまで最初の Snapshot コピーが SnapVault 関係の参照 Snapshot コピーになるため、保持処理が失敗することがあります。

. Snapshotコピーを保持する期間
+
.. Snapshotコピーを削除するまで保持する日数を指定するには、*[Keep Snapshot copies for]*を選択します。




ログの Snapshot コピーの保持期間は、デフォルトで 7 日に設定されています。ログの Snapshot コピーの保持期間を変更するには、 Set-SmPolicy コマンドレットを使用します。

ログの Snapshot コピーの保持を 2 に設定する例を次に示します。

.例を示します
[]
====
Set-SmPolicy-PolicyName 'newpol'-PolicyType 'Backup'-PluginPolicyType 'SCSQL'-sqlbackuptype 'FullBackupAndLogBackup'-RetentionSettings@｛backupType='Hourly'；RetentionCount=2｝、@｛backupType='log_snapshot'；ScheduleType=2｝

====
https://kb.netapp.com/Advice_and_Troubleshooting/Data_Protection_and_Security/SnapCenter/SnapCenter_retains_Snapshot_copies_of_the_database["SnapCenter はデータベースの Snapshot コピーを保持します"]



== ステップ4：レプリケーション設定を構成します

. Replication （レプリケーション）ページで、セカンダリストレージシステムへのレプリケーションを指定します。


[role="tabbed-block"]
====
.SnapMirrorを更新します
--
ローカルSnapshotコピーの作成後にSnapMirrorを更新します。

. 別のボリュームにバックアップセットのミラーコピーを作成する場合（ SnapMirror ）は、このオプションを選択します。


--
.SnapVault を更新します
--
Snapshotコピーの作成後にSnapVault を更新

. ディスクツーディスクのバックアップレプリケーションを実行する場合は、このオプションを選択します。


--
.セカンダリポリシーラベル
--
. Snapshot ラベルを選択します。


選択した Snapshot コピーラベルに応じて、 ONTAP はラベルに一致するセカンダリ Snapshot コピー保持ポリシーを適用します。


NOTE: ローカル Snapshot コピーの作成後に「 * SnapMirror を更新」を選択した場合は、必要に応じてセカンダリポリシーラベルを指定できます。ただし、ローカル Snapshot コピーの作成後に「 * Update SnapVault 」を選択した場合は、セカンダリポリシーラベルを指定する必要があります。

--
.エラー再試行回数
--
. レプリケーションの最大試行回数を入力します。この回数を超えると処理が停止します。


--
====


== 手順5：スクリプト設定を構成します

. スクリプトページで、バックアップ処理の前後に実行するプリスクリプトまたはポストスクリプトのパスと引数を入力します。
+
たとえば、 SNMP トラップの更新、アラートの自動化、ログの送信などをスクリプトで実行できます。

+

NOTE: プリスクリプトまたはポストスクリプトのパスにドライブまたは共有を含めることはできません。パスはscripts_pathに対する相対パスでなければなりません。

+

NOTE: セカンダリストレージが Snapshot コピーの最大数に達しないように、 ONTAP で SnapMirror 保持ポリシーを設定する必要があります。





== 手順6：検証設定を構成します

[Verification] ページで、次の手順を実行します。

. Run verification for following backup schedules セクションで、スケジュール頻度を選択します。
. Database consistency check options セクションで、次の操作を実行します。
+
.. 整合性構造をデータベースの物理構造に制限する（ physical_only ）
+
... 整合性チェックの対象をデータベースの物理構造に限定し、データベースに影響を与える正しくないページ、チェックサム障害、および一般的なハードウェア障害を検出するには、「 * 」を選択します。


.. すべての情報メッセージを抑制（INFOMSGSなし）
+
... すべての情報メッセージを停止するには、「 * 」を選択します（ NO_INFOMSGS ）。デフォルトで選択されています。


.. レポートされたすべてのエラー・メッセージをオブジェクトごとに表示する（ All_ERRORGS ）
+
... レポートされたエラーをオブジェクトごとにすべて表示する場合は、このオプションを選択します。


.. 非クラスタ化インデックス（ noindex ）をチェックしない
+
... 非クラスタ化インデックスをチェックしない場合は、「 * 非クラスタ化インデックスをチェックしない」を選択します。SQL Server データベースは、 Microsoft SQL Server の Database Consistency Checker （ DBCC ）を使用して、データベース内のオブジェクトの論理的な整合性と物理的な整合性をチェックします。


.. 内部データベースの Snapshot コピー（ TABLOCK ）を使用せずに、チェックを制限してロックを取得します。
+
... 内部データベースの Snapshot コピーを使用する代わりに、チェックを制限してロックを取得する場合は、「 * 」を選択します。このオプションを選択すると、チェックが制限され、内部データベースの Snapshot コピーを使用する代わりにロックが取得されます。




. [ ログ・バックアップ * ] セクションで、 [ 完了時にログ・バックアップを検証する * ] を選択し、完了時にログ・バックアップを検証します。
. 検証スクリプトの設定 * セクションで、検証処理の前後に実行するプリスクリプトまたはポストスクリプトのパスと引数を入力します。
+

NOTE: プリスクリプトまたはポストスクリプトのパスにドライブまたは共有を含めることはできません。パスはscripts_pathに対する相対パスでなければなりません。





== ステップ7：概要を確認します

. 概要を確認し、*[終了]*を選択します。

